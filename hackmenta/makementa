#!/bin/bash
set -e

# Si no tenes polipo aclara esta linea
#export http_proxy=http://localhost:8123
distro=trusty

# cosas que no necesitamos
purge=(
  adobe-flashplugin
  mono-runtime catfish evolution-data-server-goa
  language-pack-en language-pack-en-base language-pack-gnome-en
  language-pack-gnome-en-base firefox-locale-en
  xchat seahorse ristretto hexchat
  unrar metacity totem

  fonts-kacst fonts-kacst-one fonts-khmeros-core fonts-lao
  fonts-lklug-sinhala fonts-nanum fonts-sil-abyssinica fonts-sil-padauk
  fonts-takao-pgothic fonts-thai-tlwg fonts-tibetan-machine
  fonts-tlwg-garuda fonts-tlwg-kinnari fonts-tlwg-loma fonts-tlwg-mono
  fonts-tlwg-norasi fonts-tlwg-purisa fonts-tlwg-sawasdee
  fonts-tlwg-typewriter fonts-tlwg-typist fonts-tlwg-typo
  fonts-tlwg-umpush fonts-tlwg-waree ttf-punjabi-fonts
  ttf-indic-fonts-core

)

# cosas que necesitamos
packages=(
  build-essential pandoc
  ca-certificates
  deb.torproject.org-keyring tor torsocks
  pidgin-otr
  sylpheed
  thunderbird-locale-es-es enigmail xul-ext-lightning
  fish xsel
  git rsync
  language-pack-es language-pack-es-base language-pack-gnome-es
  language-pack-gnome-es-base firefox-locale-es
  kde-l10n-es gimp-help-es aspell-es
  openoffice.org-hyphenation
  myspell-es wspanish libreoffice-help-es libreoffice-l10n-es
  gpa signing-party haveged
  remmina
  tinc zim
  mini-httpd
  prosody
  nanoblogger
  rawdog
  tidy
  markdown
  python-feedparser
  qrencode
  imagemagick
  libnotify-bin
  mumble
  xmlstarlet firefox
  scantailor djvulibre-bin imagemagick ocrodjvu minidjvu
  idjc
  cryptkeeper
  parcellite
  gnome-encfs-manager
)

# plugins para firefox
#  HTTPS everywhere
#  Perspective
#  Adblock
#  Flash Video Downloader
#  Brief
#  Privacy Badger
#  Loic
morcilla=(
  https://www.eff.org/files/https-everywhere-latest.xpi
  https://addons.mozilla.org/firefox/downloads/latest/7974/addon-7974-latest.xpi
  https://addons.mozilla.org/firefox/downloads/latest/394968/platform:2/addon-394968-latest.xpi
  https://addons.mozilla.org/firefox/downloads/latest/6584/platform:2/addon-6584-latest.xpi
  https://addons.mozilla.org/firefox/downloads/latest/4578/addon-4578-latest.xpi
  https://raw.githubusercontent.com/b4zz4/loic/master/release/loic.firefox.xpi
  https://s.eff.org/files/privacy-badger-latest.xpi
)

# plugins para thunderbird
# paranoia - https://addons.mozilla.org/en-US/thunderbird/addon/paranoia/
# conversations - https://addons.mozilla.org/en-US/thunderbird/addon/gmail-conversation-view/
# display quota - https://addons.mozilla.org/en-US/thunderbird/addon/display-quota/
# lovebird - https://addons.mozilla.org/en-US/thunderbird/addon/lovebird/
morcilla_tb=(
  https://addons.mozilla.org/thunderbird/downloads/latest/451482/addon-451482-latest.xpi
  https://addons.mozilla.org/thunderbird/downloads/latest/54035/addon-54035-latest.xpi
  https://addons.mozilla.org/thunderbird/downloads/latest/881/addon-881-latest.xpi
  https://addons.mozilla.org/thunderbird/downloads/file/194876/lovebird-1.0b1-tb.xpi
)

# Retrieve the extension id for an addon from its install.rdf
# http://kb.mozillazine.org/Determine_extension_ID
get_extension_id() {
  unzip -qc $1 install.rdf | xmlstarlet sel \
        -N rdf=http://www.w3.org/1999/02/22-rdf-syntax-ns# \
        -N em=http://www.mozilla.org/2004/em-rdf# \
        -t -v \
        "//rdf:Description[@about='urn:mozilla:install-manifest']/em:id" ||
        echo
}

# no parar a preguntarnos cosas
export DEBIAN_FRONTEND=noninteractive

apt-get install --yes gnupg2 git localepurge
sed "/NEEDSCONFIGFIRST/d" -i /etc/locale.nopurge
for l in es es_AR es_AR.UTF-8 en ; do
  grep -qw "^${l}$" /etc/locale.nopurge||
    echo "${l}" >>/etc/locale.nopurge
done

echo "pasando el sistema a castellano"
echo "LANG=es_AR.UTF-8" >/etc/default/locale
echo "LANGUAGE=es_AR:es" >>/etc/default/locale
cat >/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/keyboard-layout.xml <<EOF
<?xml version="1.0" encoding="UTF-8"?>

<channel name="keyboard-layout" version="1.0">
  <property name="Default" type="empty">
    <property name="XkbDisable" type="bool" value="false"/>
    <property name="XkbLayout" type="string" value="latam"/>
    <property name="XkbModel" type="string" value="pc105"/>
  </property>
</channel>
EOF

echo "instalando duraskel"
pushd /tmp
test -d /tmp/duraskel/.git || git clone https://github.com/fauno/duraskel -b hackmenta
pushd /tmp/duraskel
make install
rsync -av src/ /root/
popd

# pisar la configuración de pidgin con nuestra propia configuración
cp -fv /tmp/{blist,accounts}.xml /etc/skel/.purple
mkdir -p /etc/skel/.purple/certificates/x509/tls_peers
cat /tmp/irc.hackcoop.com.ar.crt >/etc/skel/.purple/certificates/x509/tls_peers/irc.hackcoop.com.ar

# modifica las variables al crear un usuario
echo '#!/bin/bash' >/usr/local/sbin/adduser.local
echo 'sed -i "s/persona/${1}/g" "${4}/.purple/"*' >>/usr/local/sbin/adduser.local
echo 'sed -i "s,~,${4},g" "${4}/.config/transmission/settings.json"' >>/usr/local/sbin/adduser.local
chmod +x /usr/local/sbin/adduser.local

echo "configurando repositorio gnome-encfs-manager"
echo "deb http://ppa.launchpad.net/gencfsm/ppa/ubuntu ${distro} main" >/etc/apt/sources.list.d/gencfsm.list

echo "configurando repositorios tor"
# https://www.torproject.org/docs/debian.html.en
echo "deb     https://deb.torproject.org/torproject.org ${distro} main" > /etc/apt/sources.list.d/tor.list

# a veces hay errores temporales en la obtencion de llaves
i=0
while test $i -ne 10 ;do
  http_proxy= \
  gpg2 --keyserver pool.sks-keyservers.net \
       --recv A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89 \
  && break

  echo "falló obtener clave de tor, reintentando"
  let i++ || true
done
gpg2 --export A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89 | sudo apt-key add -


echo "sacando porquerías e instalando paquetes"
apt-get update
apt-get purge --yes ${purge[@]}
# http://askubuntu.com/a/520941
touch /var/run/utmp
# propio :P
patch /etc/init.d/udev /tmp/udev_disable_hotplug.patch
# https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1325142/comments/9
echo "libpam-systemd hold"|dpkg --set-selections
apt-get upgrade --yes
apt-get autoremove --yes
patch /etc/init.d/udev /tmp/udev_enable_hotplug.patch
echo "libpam-systemd install"|dpkg --set-selections
apt-get install --yes ${packages[@]}

# esto es un bardo sólo porque debian sacó cacert.org de ca-certificates
echo "instalando cacert.org"
# ver cacert-dot-org en parabola
wget http://www.cacert.org/certs/root.crt http://www.cacert.org/certs/class3.crt
sha1_ok="SHA1 Fingerprint=13:5C:EC:36:F4:9C:B8:E9:3B:1A:B2:70:CD:80:88:46:76:CE:8F:33"
sha1_test="$(openssl x509 -noout -fingerprint -in root.crt)"

test "${sha1_ok}" == "${sha1_test}" &&
install -Dm644 root.crt /usr/local/share/ca-certificates/cacert.org/cacert.org_root.crt

cert_ok="class3.crt: OK"
cert_test="$(openssl verify -CAfile root.crt -verbose class3.crt)"

test "${cert_ok}" == "${cert_test}" &&
install -Dm644 class3.crt /usr/local/share/ca-certificates/cacert.org/cacert.org_class3.crt

sed '/^!cacert\.org/d' -i /etc/ca-certificates.conf
install -dm755 /etc/ca-certificates/update.d
echo "cacert.org/cacert.org_root.crt" >>/etc/ca-certificates/update.d/cacert.conf
echo "cacert.org/cacert.org_class3.crt" >>/etc/ca-certificates/update.d/cacert.conf

update-ca-certificates --fresh

echo "instalando librevpn"
pushd /tmp
test -d /tmp/librevpn/.git || git clone https://github.com/fauno/librevpn
pushd /tmp/librevpn
make install PREFIX=/usr

echo "descargando plugins de thunderbird"
pushd /usr/lib/thunderbird-addons/extensions/
wget -c ${morcilla_tb[@]}
popd

echo "descargando plugins de firefox"
pushd /usr/lib/firefox-addons/distribution/extensions/
wget -c ${morcilla[@]}
popd

echo "instalando plugins de mozilla"
for i in /usr/lib/{thunderbird-addons,firefox-addons/distribution}/extensions/*.xpi; do
  id="$(get_extension_id "$i")"

  test -z "$id" && continue
  mkdir "${i%/*}/$id" || continue
  pushd "${i%/*}/$id"
  unzip "$i"
  popd
done

find /usr/lib/thunderbird-addons/extensions/ \
     /usr/lib/firefox-addons/distribution/extensions/ \
     -type d -exec chmod 755 {} \;

find /usr/lib/thunderbird-addons/extensions/ \
     /usr/lib/firefox-addons/distribution/extensions/ \
     -type f -exec chmod 644 {} \;

cat >/etc/skel/.mozilla/firefox/mwad0hks.default/prefs.js <<EOF
// Deshabilitar pedirle permiso a Google para ver un sitio
user_pref("browser.safebrowsing.enabled", false);
//
user_pref("extensions.update.enabled", true);

// Use LANG environment variable to choose locale
user_pref("intl.locale.matchOS", true);

// Disable default browser checking.
user_pref("browser.shell.checkDefaultBrowser", false);

// Prevent EULA dialog to popup on first run
user_pref("browser.EULA.override", true);

// Set the UserAgent
user_pref("general.useragent.vendor", "HackMenta");
user_pref("general.useragent.vendorSub", "17");
user_pref("general.useragent.vendorComment", "Qiana");

// Default search engine
user_pref("browser.search.order.1", "DuckDuckGo");
user_pref("browser.search.order.2", "Ixquick");
user_pref("browser.search.order.3", "Startpage");
user_pref("browser.search.selectedEngine", "DuckDuckGo");
user_pref("browser.search.searchEnginesURL", "http://www.linuxmint.com/searchengines/");
user_pref("keyword.URL", "https://duckduckgo.com/?t=lm&q=");

// Activate the backspace key for browsing back
user_pref("browser.backspace_action", 0);

// enable ipv6
user_pref("network.dns.disableIPv6", false);

// Ignore Mozilla release notes startup pages
user_pref("browser.startup.homepage_override.mstone", "ignore");

// Homepage
user_pref("browser.startup.homepage", "http://wiki.hackcoop.com.ar/");

// Save tabs before exiting
user_pref("browser.showQuitWarning", true);

// apturl
user_pref("network.protocol-handler.app.apt",  "/usr/bin/apturl");
user_pref("network.protocol-handler.app.apt+http",  "/usr/bin/apturl");
user_pref("network.protocol-handler.warn-external.apt", true);
user_pref("network.protocol-handler.warn-external.apt+http", true);

// identify default locale to use if no /usr/lib/firefox-addons/searchplugins/LOCALE
// exists for the current used LOCALE
user_pref("distribution.searchplugins.defaultLocale", "es-AR");

// Enable the NetworkManager integration
//user_pref("network.manage-offline-status", true);

// Don't disable our bundled extensions in the application directory
user_pref("extensions.autoDisableScopes", 0);
user_pref("extensions.shownSelectionUI", true);

// Map to hyphenation patterns from openoffice.org-hyphenation and openoffice.org-dictionaries
user_pref("intl.hyphenation-alias.af", "af-za");
user_pref("intl.hyphenation-alias.af-*", "af-za");
user_pref("intl.hyphenation-alias.bn", "bn-in");
user_pref("intl.hyphenation-alias.bn-*", "bn-in");
user_pref("intl.hyphenation-alias.ca-*", "ca");
user_pref("intl.hyphenation-alias.cs", "cs-cz");
user_pref("intl.hyphenation-alias.cs-*", "cs-cz");
user_pref("intl.hyphenation-alias.da", "da-dk");
user_pref("intl.hyphenation-alias.da-*", "da-dk");
user_pref("intl.hyphenation-alias.de", "de-de");
user_pref("intl.hyphenation-alias.de-*", "de-de");
user_pref("intl.hyphenation-alias.de-AT-1901", "de-de");
user_pref("intl.hyphenation-alias.de-CH-*", "de-de");
user_pref("intl.hyphenation-alias.de-DE-1901", "de-de");
user_pref("intl.hyphenation-alias.el", "el-gr");
user_pref("intl.hyphenation-alias.el-*", "el-gr");
user_pref("intl.hyphenation-alias.en", "en-us");
user_pref("intl.hyphenation-alias.en-*", "en-us");
user_pref("intl.hyphenation-alias.es", "es-es");
user_pref("intl.hyphenation-alias.es-*", "es-es");
user_pref("intl.hyphenation-alias.et", "et-ee");
user_pref("intl.hyphenation-alias.et-*", "et-ee");
user_pref("intl.hyphenation-alias.fi", "fi-fi");
user_pref("intl.hyphenation-alias.fi-*", "fi-fi");
user_pref("intl.hyphenation-alias.fr-*", "fr");
user_pref("intl.hyphenation-alias.ga", "ga-ie");
user_pref("intl.hyphenation-alias.ga-*", "ga-ie");
user_pref("intl.hyphenation-alias.gu", "gu-in");
user_pref("intl.hyphenation-alias.gu-*", "gu-in");
user_pref("intl.hyphenation-alias.hi", "hi-in");
user_pref("intl-hyphenation-alias.hi-in", "hi-in");
user_pref("intl.hyphenation-alias.hr", "hr-hr");
user_pref("intl.hyphenation-alias.hr-*", "hr-hr");
user_pref("intl.hyphenation-alias.hu", "hu-hu");
user_pref("intl.hyphenation-alias.hu-*", "hu-hu");
user_pref("intl.hyphenation-alias.id", "id-id");
user_pref("intl-hyphenation-alias.id-*", "id-id");
user_pref("intl.hyphenation-alias.is", "is-is");
user_pref("intl.hyphenation-alias.is-*", "is-is");
user_pref("intl.hyphenation-alias.it", "it-it");
user_pref("intl.hyphenation-alias.it-*", "it-it");
user_pref("intl.hyphenation-alias.kn", "kn-in");
user_pref("intl.hyphenation-alias.kn-*", "kn-in");
user_pref("intl.hyphenation-alias.lt", "lt-lt");
user_pref("intl.hyphenation-alias.lt-*", "lt-lt");
user_pref("intl.hyphenation-alias.lv", "lv-lv");
user_pref("intl.hyphenation-alias.lv-*", "lv-lv");
user_pref("intl.hyphenation-alias.nb", "nb-no");
user_pref("intl.hyphenation-alias.nb-*", "nb-no");
user_pref("intl.hyphenation-alias.nl", "nl-nl");
user_pref("intl.hyphenation-alias.nl-*", "nl-nl");
user_pref("intl.hyphenation-alias.nn", "nn-no");
user_pref("intl.hyphenation-alias.nn-*", "nn-no");
user_pref("intl.hyphenation-alias.pa", "pa-in");
user_pref("intl.hyphenation-alias.pa-*", "pa-in");
user_pref("intl.hyphenation-alias.pl", "pl-pl");
user_pref("intl.hyphenation-alias.pl-*", "pl-pl");
user_pref("intl.hyphenation-alias.pt", "pt-pt");
user_pref("intl.hyphenation-alias.pt-*", "pt-pt");
user_pref("intl.hyphenation-alias.ro", "ro-ro");
user_pref("intl.hyphenation-alias.ro-*", "ro-ro");
user_pref("intl.hyphenation-alias.ru", "ru-ru");
user_pref("intl.hyphenation-alias.ru-*", "ru-ru");
user_pref("intl.hyphenation-alias.sh-*", "sh");
user_pref("intl.hyphenation-alias.sk", "sk-sk");
user_pref("intl.hyphenation-alias.sk-*", "sk-sk");
user_pref("intl.hyphenation-alias.sl", "sl-si");
user_pref("intl.hyphenation-alias.sl-*", "sl-si");
user_pref("intl.hyphenation-alias.sr-*", "sr");
user_pref("intl.hyphenation-alias.sv", "sv-se");
user_pref("intl.hyphenation-alias.sv-*", "sv-se");
user_pref("intl.hyphenation-alias.uk", "uk-ua");
user_pref("intl.hyphenation-alias.uk-*", "uk-ua");
user_pref("intl.hyphenation-alias.zu", "zu-za");
user_pref("intl.hyphenation-alias.zu-*", "zu-za");
EOF

# Inicio de programas
mkdir -p /etc/skel/.config/autostart
cd /etc/skel/.config/autostart
## Inicio del historial del portapapeles
cp /usr/share/applications/parcellite.desktop .
## Inicio de cifrado de carpetas
cp /usr/share/applications/cryptkeeper.desktop .

echo "seteando shell por defecto"
sed "s,/usr,," -i /etc/shells
sed "s/^DSHELL=.*/DSHELL=\/bin\/fish/" -i /etc/adduser.conf
ln -sv /usr/bin/fish /bin/

echo "instalando syncthing"
add-apt-repository --yes ppa:ytvwld/syncthing
add-apt-repository --yes ppa:nilarimogard/webupd8
apt-get update --yes
apt-get install --yes syncthing syncthing-gtk

echo "instalando dl.git"
pushd /etc/skel/
git clone http://repo.hackcoop.com.ar/dl.git
mkdir -p .config/fish
echo 'PATH=~/dl:$PATH' >>.bashrc
echo 'set PATH $PATH ~/dl' >>.config/fish/config.fish

echo "actualizando base de datos de manpages"
/usr/share/fish/tools/create_manpage_completions.py \
  --manpath \
  --progress \
  --directory /etc/skel/.config/fish/generated_completions

echo "instalando tor browser bundle"
# TODO esta en inglés
add-apt-repository --yes ppa:webupd8team/tor-browser
apt-get update --yes
apt-get install --yes tor-browser

pushd /tmp
# logos
cp logo.svg /usr/share/linuxmint/common/artwork/logos/scalable.svg

LOGO="logo.png"

for logo in /usr/share/linuxmint/common/artwork/logos/16.png
            /usr/share/linuxmint/common/artwork/logos/22.png
            /usr/share/linuxmint/common/artwork/logos/24.png
            /usr/share/linuxmint/common/artwork/logos/32.png
            /usr/share/linuxmint/common/artwork/logos/48.png
            /usr/share/linuxmint/logo.png
            /usr/share/linuxmint/mintinstall/icons/mintbackup.png
            /usr/share/linuxmint/mintinstall/icons/mintdesktop.png
            /usr/share/linuxmint/mintinstall/icons/mintinstall.png
            /usr/share/linuxmint/mintinstall/icons/mintmenu.png
            /usr/share/linuxmint/mintinstall/icons/mintnanny.png
            /usr/share/linuxmint/mintinstall/icons/mintupdate.png
            /usr/share/linuxmint/mintinstall/icons/mintupload.png
            /lib/plymouth/themes/mint-logo/logo.png ; do

  # obtener la resolución
	size=$(identify -verbose "${logo}" |
           grep "geometry" |
           cut -d'+' -f1 | cut -d':' -f2)
  # convertir nuestro logo a la resolución correspondiente
	convert "${LOGO}" -resize ${size} "${logo}"
done

# logos con marca de instalados
for logo in /usr/share/linuxmint/mintinstall/installed/mintbackup.png
            /usr/share/linuxmint/mintinstall/installed/mintdesktop.png
            /usr/share/linuxmint/mintinstall/installed/mintinstall.png
            /usr/share/linuxmint/mintinstall/installed/mintmenu.png
            /usr/share/linuxmint/mintinstall/installed/mintnanny.png
            /usr/share/linuxmint/mintinstall/installed/mintupdate.png
            /usr/share/linuxmint/mintinstall/installed/mintupload.png ; do
	convert "${logo/installed/icons}" -gravity SouthEast \
          /usr/share/linuxmint/mintinstall/emblem-installed.png \
          -composite "${logo}"
done

update-initramfs -u

# fondo de pantalla
cp fondo.png /usr/share/backgrounds/linuxmint-qiana/linux_mint_17.png
cp fondo.png /usr/share/backgrounds/linuxmint-qiana/linux_mint_qiana.png

